<!DOCTYPE html>
<html>
    <head>
        <title>Talker discrimination task</title>
        <script src="jspsych/jspsych.js"></script>
        <script src="jspsych/plugin-html-keyboard-response.js"></script>
        <script src="jspsych/plugin-audio-keyboard-response.js"></script>
        <script src="jspsych/plugin-preload.js"></script>
        <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
    </head>
    <body></body>
    <script>


        // set up

        // initialize jsPsych
        const jsPsych = initJsPsych({
                    on_finish: function() {
                                jsPsych.data.displayData();
                                const data = jsPsych.data.get().json();
                                save_data_to_server(data);
                            }
                });

        // create timeline
        let timeline = [];

        // preload images
        const preload = {
                    type: jsPsychPreload,
                    auto_preload: true,
                };



        // define trials

        // define welcome message trial
        const welcome = {
                    type: jsPsychHtmlKeyboardResponse,
                    stimulus: "Welcome to the experiment. Press any key to begin."
                };

        // define instructions trial
        const instructions = {
                    type: jsPsychHtmlKeyboardResponse,
                    stimulus: `
                    <p>In this experiment, a circle will appear in the center
       of the screen.</p><p>If the circle is <strong>blue</strong>, press the letter F on the keyboard as fast as you can.</p><p>If the circle is <strong>orange</strong>, press the letter J as fast as you can.</p>
       <p>Press any key to begin.</p>
        `,
                    post_trial_gap: 2000
                };

        // define fixation trial
        const fixation = {
                    type: jsPsychHtmlKeyboardResponse,
                    stimulus: '<div style="font-size:60px;">+</div>',
                    choices: "NO_KEYS",
                    trial_duration: 1000,
                    data: {
                                task: "fixation"
                            }
                };

        // define trial stimuli array for timeline variables
        const similar_vowels_stimuli = [
                    { stimulus: "stim/A/AA1.wav", vowel: "AA", talker: "A", vowel_space: "similar" },
                    { stimulus: "stim/A/AA2.wav", vowel: "AA", talker: "A", vowel_space: "similar" },
                    { stimulus: "stim/A/AA3.wav", vowel: "AA", talker: "A", vowel_space: "similar" },
                    { stimulus: "stim/A/EH1.wav", vowel: "EH", talker: "A", vowel_space: "similar" },
                    { stimulus: "stim/A/EH2.wav", vowel: "EH", talker: "A", vowel_space: "similar" },
                    { stimulus: "stim/A/EH3.wav", vowel: "EH", talker: "A", vowel_space: "similar" },
                    { stimulus: "stim/A/IH1.wav", vowel: "IH", talker: "A", vowel_space: "similar" },
                    { stimulus: "stim/A/IH2.wav", vowel: "IH", talker: "A", vowel_space: "similar" },
                    { stimulus: "stim/A/IH3.wav", vowel: "IH", talker: "A", vowel_space: "similar" },
                    { stimulus: "stim/A/OO1.wav", vowel: "OO", talker: "A", vowel_space: "similar" },
                    { stimulus: "stim/A/OO2.wav", vowel: "OO", talker: "A", vowel_space: "similar" },
                    { stimulus: "stim/A/OO3.wav", vowel: "OO", talker: "A", vowel_space: "similar" },

                    { stimulus: "stim/B/AA1.wav", vowel: "AA", talker: "B", vowel_space: "similar" },
                    { stimulus: "stim/B/AA2.wav", vowel: "AA", talker: "B", vowel_space: "similar" },
                    { stimulus: "stim/B/AA3.wav", vowel: "AA", talker: "B", vowel_space: "similar" },
                    { stimulus: "stim/B/EH1.wav", vowel: "EH", talker: "B", vowel_space: "similar" },
                    { stimulus: "stim/B/EH2.wav", vowel: "EH", talker: "B", vowel_space: "similar" },
                    { stimulus: "stim/B/EH3.wav", vowel: "EH", talker: "B", vowel_space: "similar" },
                    { stimulus: "stim/B/IH1.wav", vowel: "IH", talker: "B", vowel_space: "similar" },
                    { stimulus: "stim/B/IH2.wav", vowel: "IH", talker: "B", vowel_space: "similar" },
                    { stimulus: "stim/B/IH3.wav", vowel: "IH", talker: "B", vowel_space: "similar" },
                    { stimulus: "stim/B/OO1.wav", vowel: "OO", talker: "B", vowel_space: "similar" },
                    { stimulus: "stim/B/OO2.wav", vowel: "OO", talker: "B", vowel_space: "similar" },
                    { stimulus: "stim/B/OO3.wav", vowel: "OO", talker: "B", vowel_space: "similar" },
                    ];

        const stim_order = [
                    {"group":"0","block_number":1,"block_vowel_space":"training","rep":1,"vowel1":"IH","vowel2":"EH","exemplar1":1,"exemplar2":1,"talker1":"A","talker2":"B","path1":"stim/A/IH1.wav","path2":"stim/B/EH1.wav","same":0,"key":"f"},{"group":"0","block_number":1,"block_vowel_space":"training","rep":2,"vowel1":"OO","vowel2":"IH","exemplar1":3,"exemplar2":2,"talker1":"A","talker2":"A","path1":"stim/A/OO3.wav","path2":"stim/A/IH2.wav","same":1,"key":"j"},{"group":"0","block_number":1,"block_vowel_space":"training","rep":3,"vowel1":"IH","vowel2":"IH","exemplar1":2,"exemplar2":3,"talker1":"X","talker2":"X","path1":"stim/X/IH2.wav","path2":"stim/X/IH3.wav","same":1,"key":"j"},{"group":"0","block_number":1,"block_vowel_space":"training","rep":4,"vowel1":"EH","vowel2":"OO","exemplar1":2,"exemplar2":2,"talker1":"Y","talker2":"Y","path1":"stim/Y/EH2.wav","path2":"stim/Y/OO2.wav","same":1,"key":"j"},{"group":"0","block_number":1,"block_vowel_space":"training","rep":5,"vowel1":"OO","vowel2":"EH","exemplar1":1,"exemplar2":3,"talker1":"B","talker2":"A","path1":"stim/B/OO1.wav","path2":"stim/A/EH3.wav","same":0,"key":"f"},
                    ];
        //const different_vowels_stimuli = [
                    //{ stimulus: "stim/X/AA1.wav", vowel: "AA", talker: "X", vowel_space: "different" },
                    //{ stimulus: "stim/X/AA2.wav", vowel: "AA", talker: "X", vowel_space: "different" },
                    //{ stimulus: "stim/X/AA3.wav", vowel: "AA", talker: "X", vowel_space: "different" },
                    //{ stimulus: "stim/X/EH1.wav", vowel: "EH", talker: "X", vowel_space: "different" },
                    //{ stimulus: "stim/X/EH2.wav", vowel: "EH", talker: "X", vowel_space: "different" },
                    //{ stimulus: "stim/X/EH3.wav", vowel: "EH", talker: "X", vowel_space: "different" },
                    //{ stimulus: "stim/X/IH1.wav", vowel: "IH", talker: "X", vowel_space: "different" },
                    //{ stimulus: "stim/X/IH2.wav", vowel: "IH", talker: "X", vowel_space: "different" },
                    //{ stimulus: "stim/X/IH3.wav", vowel: "IH", talker: "X", vowel_space: "different" },
                    //{ stimulus: "stim/X/OO1.wav", vowel: "OO", talker: "X", vowel_space: "different" },
                    //{ stimulus: "stim/X/OO2.wav", vowel: "OO", talker: "X", vowel_space: "different" },
                    //{ stimulus: "stim/X/OO3.wav", vowel: "OO", talker: "X", vowel_space: "different" },
//
                    //{ stimulus: "stim/Y/AA1.wav", vowel: "AA", talker: "Y", vowel_space: "different" },
                    //{ stimulus: "stim/Y/AA2.wav", vowel: "AA", talker: "Y", vowel_space: "different" },
                    //{ stimulus: "stim/Y/AA3.wav", vowel: "AA", talker: "Y", vowel_space: "different" },
                    //{ stimulus: "stim/Y/EH1.wav", vowel: "EH", talker: "Y", vowel_space: "different" },
                    //{ stimulus: "stim/Y/EH2.wav", vowel: "EH", talker: "Y", vowel_space: "different" },
                    //{ stimulus: "stim/Y/EH3.wav", vowel: "EH", talker: "Y", vowel_space: "different" },
                    //{ stimulus: "stim/Y/IH1.wav", vowel: "IH", talker: "Y", vowel_space: "different" },
                    //{ stimulus: "stim/Y/IH2.wav", vowel: "IH", talker: "Y", vowel_space: "different" },
                    //{ stimulus: "stim/Y/IH3.wav", vowel: "IH", talker: "Y", vowel_space: "different" },
                    //{ stimulus: "stim/Y/OO1.wav", vowel: "OO", talker: "Y", vowel_space: "different" },
                    //{ stimulus: "stim/Y/OO2.wav", vowel: "OO", talker: "Y", vowel_space: "different" },
                    //{ stimulus: "stim/Y/OO3.wav", vowel: "OO", talker: "Y", vowel_space: "different" },
                    //];

        // play vowels
        const play_vowel_1 = {
                    type: jsPsychAudioKeyboardResponse,
                    stimulus: jsPsych.timelineVariable('path1'),
                    choices: "NO_CHOICE",
                    trial_ends_after_audio: true,
                    data: {
                                task: "vowel",
                            },
                };

        const play_vowel_2 = {
                    type: jsPsychAudioKeyboardResponse,
                    stimulus: jsPsych.timelineVariable('path2'),
                    choices: "NO_CHOICE",
                    trial_ends_after_audio: true,
                    data: {
                                task: "vowel",
                            },
                };

        // pause
        const pause = {
                    type: jsPsychHtmlKeyboardResponse,
                    stimulus: "",
                    choices: "NO_KEYS",
                    trial_duration: 500,
                };

        // collect response
        const collect_response = {
                    type: jsPsychHtmlKeyboardResponse,
                    stimulus: "",
                    choices: ["f", "j"],
                    data: {
                                task: "response",
                                vowel_space: jsPsych.timelineVariable("block_vowel_space"),
                                talker1 : jsPsych.timelineVariable("talker1"),
                                talker2 : jsPsych.timelineVariable("talker2"),
                                vowel1: jsPsych.timelineVariable("vowel1"),
                                vowel2: jsPsych.timelineVariable("vowel2"),
                                same: jsPsych.timelineVariable("same"),
                                correct_response: jsPsych.timelineVariable("key"),
                            },
                    on_finish: function(data){
                                data.correct = jsPsych.pluginAPI.compareKeys(data.response, data.correct_response);
                            },
                };

        // define test procedure that orders and presents test trials
        const play_vowels_procedure = {
                    timeline: [fixation, play_vowel_1, pause, play_vowel_2, collect_response, pause],
                    timeline_variables: stim_order,
                };

        // define break between blocks
        const intermission = {
                    type: jsPsychHtmlKeyboardResponse,
                    stimulus: `<p>This is the end of the block, you may now take a break.</p>
                             <p>Press any key to continue.</p>`,
                };

        // define debrief
        const end = {
                    type: jsPsychHtmlKeyboardResponse,
                    stimulus: function() {
                                const trials = jsPsych.data.get().filter({task: "response"});
                                const correct_trials = trials.filter({correct: true});
                                const accuracy = Math.round(correct_trials.count() / trials.count() * 100);
                                const rt = Math.round(correct_trials.select('rt').mean());

                                return `<p>You responded correctly on ${accuracy}% of the trials.</p>
       <p>Your average response time was ${rt}ms.</p>
       <p>Press any key to complete the experiment. Thank you!</p>`;
                            }
                };



        // adding data to all trials

        // select subject ID
        const subjectid = jsPsych.randomization.randomID(15);

        // add subjectid to every trial
        jsPsych.data.addProperties({
                    subject: subjectid,
                });

        // create timeline and run experiment

        // push trials to timeline
        timeline.push(preload);
        timeline.push(welcome);
        timeline.push(instructions);

        // if subject number fits a certain pattern
        // generate stimuli order with matlab, feed in subject and block number

        // testing something out
        //let block = 1
        //timeline.push(play_vowels_procedure)
        //timeline.push(intermission)
        //block++
        //timeline.push(play_vowels_procedure)
        //timeline.push(intermission)
        //block++
        //timeline.push(play_vowels_procedure)
        //timeline.push(intermission)
        //block++
        //timeline.push(play_vowels_procedure)
        //timeline.push(intermission)
        //block++

        // end test

        //const first_number = subjectid.match(/^[0-9]*$/);
        //if(first_number < 5){

            // push one test procedure
                    //timeline.push(play_similar_vowels_procedure);
                    //timeline.push(intermission);
          //          timeline.push(different_vowels_procedure);
            //        timeline.push(intermission);
              //      timeline.push(similar_vowels_procedure);
                //    timeline.push(intermission);
                  //  timeline.push(different_vowels_procedure);

            // otherwise push the other procedure
              //  } else {
                //    timeline.push(different_vowels_procedure);
                    //timeline.push(intermission);
                    //timeline.push(similar_vowels_procedure);
                    //timeline.push(intermission);
                    //timeline.push(different_vowels_procedure);
                    //timeine.push(intermission);
                    //timeline.push(similar_vowels_procedure);
                //}
        timeline.push(play_vowels_procedure);
        timeline.push(intermission);
        timeline.push(end);

        // run the experiment
        jsPsych.run(timeline);
    </script>
</html>
